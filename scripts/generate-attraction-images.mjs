#!/usr/bin/env node

/**
 * Generate attraction-images.ts from available attraction images
 * Runs during build to auto-discover available attraction images
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const PARKS_DIR = path.join(__dirname, '../public/images/parks');
const OUTPUT_FILE = path.join(__dirname, '../lib/attraction-images.ts');

function getAllAttractionImages() {
  const images = {};
  const SUPPORTED_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.webp'];

  if (!fs.existsSync(PARKS_DIR)) {
    console.error('âŒ Parks directory not found:', PARKS_DIR);
    process.exit(1);
  }

  const parkDirs = fs
    .readdirSync(PARKS_DIR, { withFileTypes: true })
    .filter((dirent) => dirent.isDirectory())
    .map((dirent) => dirent.name);

  for (const parkDir of parkDirs) {
    const parkPath = path.join(PARKS_DIR, parkDir);

    // Scan for image files directly in the park directory
    const files = fs.readdirSync(parkPath, { withFileTypes: true });

    for (const file of files) {
      if (file.isFile()) {
        const ext = path.extname(file.name).toLowerCase();
        const baseName = path.basename(file.name, ext);

        // Include all image files except background.jpg
        if (SUPPORTED_EXTENSIONS.includes(ext) && baseName !== 'background') {
          const key = `${parkDir}/${baseName}`;
          const webPath = `/images/parks/${parkDir}/${file.name}`;
          images[key] = webPath;
        }
      }
    }
  }

  return images;
}

function generateTypeScriptFile(images) {
  const entries = Object.entries(images)
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([key, value]) => `  '${key}': '${value}',`)
    .join('\n');

  const content = `// Auto-generated by scripts/generate-attraction-images.mjs
// DO NOT EDIT MANUALLY - Run 'pnpm build' or 'pnpm generate:attraction-images' to regenerate

/**
 * Available attraction images for park detail pages
 * Generated at build time from public/images/parks/[park]/[attraction].{jpg,png,webp}
 * Maps parkSlug/attractionSlug to image path
 */
export const ATTRACTION_IMAGES: Record<string, string> = {
${entries}
};

/**
 * Get attraction background image path
 * @param parkSlug - Park slug
 * @param attractionSlug - Attraction slug
 * @returns Image path or null if not found
 */
export function getAttractionImage(parkSlug: string, attractionSlug: string): string | null {
  return ATTRACTION_IMAGES[\`\${parkSlug}/\${attractionSlug}\`] || null;
}
`;

  return content;
}

function main() {
  console.log('ðŸŽ¢ Generating attraction images map...');

  const images = getAllAttractionImages();
  const count = Object.keys(images).length;

  if (count === 0) {
    console.warn('âš ï¸  No attraction images found!');
  } else {
    console.log(`âœ… Found ${count} attraction images:`);
    Object.entries(images).forEach(([key, path]) => console.log(`   - ${key} â†’ ${path}`));
  }

  const content = generateTypeScriptFile(images);

  // Ensure lib directory exists
  const libDir = path.dirname(OUTPUT_FILE);
  if (!fs.existsSync(libDir)) {
    fs.mkdirSync(libDir, { recursive: true });
  }

  fs.writeFileSync(OUTPUT_FILE, content, 'utf8');
  console.log(`âœ… Generated ${OUTPUT_FILE}`);
}

main();
